# Retrieve customer information to find the top/loyal customers among the top 10 countries

SELECT C.CUSTOMER_ID, C.FIRST_NAME, 
CNTRY.COUNTRY, CITY.CITY, SUM(P.AMOUNT) TOTAL_AMOUNT 
FROM PAYMENT P
JOIN CUSTOMER C ON P.CUSTOMER_ID = C.CUSTOMER_ID 
JOIN ADDRESS A ON C.ADDRESS_ID = A.ADDRESS_ID
JOIN CITY ON A.CITY_ID = CITY.CITY_ID
JOIN COUNTRY CNTRY ON CITY.COUNTRY_ID = CNTRY.COUNTRY_ID
GROUP BY C.CUSTOMER_ID, C.FIRST_NAME, CNTRY.COUNTRY, CITY.CITY
HAVING CITY.CITY IN
(
	SELECT CITY.CITY
	FROM CUSTOMER C
	JOIN ADDRESS A ON C.ADDRESS_ID = A.ADDRESS_ID
	JOIN CITY ON A.CITY_ID = CITY.CITY_ID
	JOIN COUNTRY CNTRY ON CITY.COUNTRY_ID = CNTRY.COUNTRY_ID
	WHERE COUNTRY IN
	(
		SELECT COUNTRY
		FROM CUSTOMER C
		JOIN ADDRESS A ON C.ADDRESS_ID = A.ADDRESS_ID
		JOIN CITY ON A.CITY_ID = CITY.CITY_ID
		JOIN COUNTRY CNTRY ON CITY.COUNTRY_ID = CNTRY.COUNTRY_ID
		GROUP BY COUNTRY
		LIMIT 10
	)
	GROUP BY CNTRY.COUNTRY, CITY.CITY
	ORDER BY COUNT(C.CUSTOMER_ID) DESC
	LIMIT 10
)
ORDER BY COUNT(C.CUSTOMER_ID) DESC,SUM(P.AMOUNT) DESC
LIMIT 5
